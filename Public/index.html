<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with Video</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #messages { list-style-type: none; padding: 0; }
    #messages li { padding: 8px; margin-bottom: 10px; background: #f4f4f4; }
    #input { width: 80%; padding: 10px; }
    #send { padding: 10px; }
    #videos { display: flex; flex-wrap: wrap; }
    video { width: 300px; margin: 10px; }
  </style>
</head>
<body>
  <h1>Chat with Video</h1>
  <ul id="messages"></ul>
  <input id="input" autocomplete="off" /><button id="send">Send</button>
  <button id="startVideo">Start Video</button>
  <div id="videos"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const socket = io();

    // Chat functionality
    socket.on('connect', () => {
      console.log('Connected to server');
    });

    socket.on('message', (msg) => {
      const messages = document.getElementById('messages');
      const message = document.createElement('li');
      message.textContent = msg;
      messages.appendChild(message);
    });

    document.getElementById('send').addEventListener('click', () => {
      const input = document.getElementById('input');
      socket.emit('message', input.value);
      input.value = '';
    });

    // Peer-to-peer video communication
    document.getElementById('startVideo').addEventListener('click', () => {
      const videoContainer = document.getElementById('videos');
      const myVideo = document.createElement('video');
      myVideo.muted = true;
      videoContainer.appendChild(myVideo);

      navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      }).then(stream => {
        myVideo.srcObject = stream;
        myVideo.play();

        const peer = new SimplePeer({
          initiator: location.hash === '#init',
          trickle: false,
          stream: stream
        });

        peer.on('signal', data => {
          socket.emit('signal', {
            signal: data,
            callerId: socket.id,
            target: 'all' // For simplicity, sending signal to all connected users
          });
        });

        socket.on('signal', data => {
          peer.signal(data.signal);
        });

        peer.on('stream', stream => {
          const userVideo = document.createElement('video');
          userVideo.srcObject = stream;
          userVideo.play();
          videoContainer.appendChild(userVideo);
        });
      }).catch(error => {
        console.error('Error accessing media devices.', error);
      });
    });
  </script>
</body>
</html>
